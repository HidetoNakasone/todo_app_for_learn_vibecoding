# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを操作する際のガイダンスを提供します。

## プロジェクト概要

Next.js 15、TypeScript、PostgreSQL、Prisma ORM を使用したモダンな TODO アプリケーションです。Docker コンテナでの実行を前提として設計され、スタイリングには TailwindCSS を使用しています。

**詳細情報**：

- プロジェクト全体概要：[README.md](./README.md)
- 要件・設計書：[docs/ ディレクトリ](./docs/)
- 技術学習記録：[docs/tech_note/](./docs/tech_note/)

## 開発コマンド

### 基本開発コマンド

```bash
# 開発・ビルド・品質チェック
bun run dev          # 開発サーバー起動（Turbopack使用）
bun run build        # 本番用アプリケーションビルド
bun run start        # 本番サーバー起動
bun run lint         # ESLintによるコード品質チェック

# Git操作
bunx cz              # 対話式コミット（推奨）
git commit           # Claude Code がコミットする場合はこちら。対話式コマンド使えないので。

# データベース操作
bun prisma studio    # データベースGUI（コンテナ内）
```

**Note**: `npm` でも同様のコマンド実行可能ですが、このプロジェクトでは `bun` の使用を推奨

### 開発環境セットアップ

```bash
# 基本的なセットアップ（.env 自動生成・Docker起動）
bash ./scripts/setup-dev.sh

# VSCode Dev Container で開発開始
code . # → Dev Containers: Reopen in Container
```

**詳細手順・トラブルシューティング**：[README.md](./README.md) または [docs/environment-optimization.md](./docs/environment-optimization.md) を参照

### データベース操作

```bash
# appコンテナ内で実行
bun prisma migrate dev    # 開発環境でのデータベースマイグレーション実行
bun prisma generate      # Prismaクライアント生成
bun prisma studio        # データベースGUIのPrisma Studio起動
```

## アーキテクチャ

### 技術スタック

- **フロントエンド**: Next.js 15 (App Router)、React 19、TypeScript
- **スタイリング**: TailwindCSS v4、shadcn/ui コンポーネント
- **バックエンド**: Next.js API Routes
- **データベース**: PostgreSQL with Prisma ORM
- **バリデーション**: Zod スキーマバリデーション
- **コンテナ**: Docker & Docker Compose

### ディレクトリ構造

```
src/
├── app/                    # Next.js App Router
│   ├── api/               # APIルート
│   ├── _components/       # 再利用可能コンポーネント
│   ├── _lib/             # ユーティリティ (utils, validations, db, types)
│   └── _hooks/           # カスタムReactフック
├── generated/prisma/      # 生成されたPrismaクライアント
└── prisma/               # データベーススキーマとマイグレーション
```

### データベーススキーマ

- **Tasks**: id、name、description、priority (HIGH/MEDIUM/LOW)、status (TODO/IN_PROGRESS/COMPLETED)、dueDate、categoryId
- **Categories**: id、name、color (hex)、tasks リレーション
- Prisma クライアントは `src/generated/prisma/` に生成される（カスタム出力場所）

### 主要機能

- 優先度と状態管理を含むタスク CRUD 操作
- 色分けによるカテゴリ管理
- 検索・フィルタリング機能
- データエクスポート/インポート (JSON/CSV)
- デスクトップ/タブレット/モバイル対応レスポンシブデザイン
- Docker ベース開発・本番デプロイメント

## 開発ガイドライン

### コード規約

- TypeScript を厳密に使用し、適切な型定義を行う
- Next.js 15 App Router パターンに従う（Server/Client Components）
- すべてのデータベース操作に Prisma ORM を使用
- Zod バリデーションによる適切なエラーハンドリングを実装
- レスポンシブデザインの原則を維持
- カスタムパスエイリアス `@/*` を `./src/*` に使用

### エラーチェック・品質管理

**開発サーバー起動前の必須チェック**：

```bash
# 1. VSCode診断情報の確認（構文エラー、型エラーなど）
# → mcp__ide__getDiagnostics ツールで確認

# 2. ESLint によるコード品質チェック
bun run lint

# 3. TypeScript 型チェック（ビルドなし）
bunx tsc --noEmit
```

**重要**: `bun run dev` 実行前に上記チェックを必ず行い、エラーがないことを確認する。エラーが発生している状態での開発サーバー起動は避ける。

### コード整形・フォーマット

**Claude によるファイル編集時の整形ルール**：

- **個別ファイル整形**: Claude がファイル編集後、必ずそのファイルに `bun prettier --write ファイル名` を実行
- **目的**: ユーザーが保存時にコード整形で差分が発生することを防ぐ
- **全体整形**: `bun run lint:fix` で ESLint 自動修正 + prettier 全体整形を一括実行可能

### データベース開発

- データベース URL は `DATABASE_URL` 環境変数で設定
- パッケージマネージャーは `bun` を使用（セットアップスクリプトで設定）
- Prisma クライアント生成前に必ずマイグレーションを実行
- Prisma クライアントはカスタム場所に生成: `src/generated/prisma/`

### コンテナ開発

- 開発環境では `compose.yaml` を使用
- 本番環境では `compose.prd.yaml` を使用
- セットアップスクリプトがコンテナオーケストレーションとデータベース初期化を処理
- アプリはポート 3000、PostgreSQL はポート 5432 で動作

## テスト・品質

### コード品質

- Next.js TypeScript ルールで ESLint を設定
- `npm run lint` でコード品質をチェック
- TypeScript strict モードが有効
- 全コンポーネントを適切に型付け

### パフォーマンス要件

- ページ読み込み時間: 3 秒以内
- API 応答時間: 1 秒以内
- 全画面サイズでレスポンシブデザイン

## 環境セットアップ注意事項

- プロジェクトではコンテナ内で Bun をパッケージマネージャーとして使用
- VSCode 開発用の Dev Container セットアップが利用可能
- 詳細なセットアップ手順・トラブルシューティングは [README.md](./README.md) を参照
- データベース初期化はセットアップスクリプトで自動処理

### 隠しファイル確認の重要性

- `.env` ファイル関連の作業前は、必ず `bash ls -la | grep "\.env"` で隠しファイルを確認すること
- LS ツールでは `.env.local` や `.env.development` などの隠しファイルが表示されないため、見落としやすい
- 既存の環境設定ファイルがないか確認してから、新規作成を行うこと

## チャット開始時に必ず読み込む場所

セッション開始時は必ず以下のファイルを読み込むこと：

1. `_GenAIキャラクター設定.md` - キャラクター設定
   コーディングサポート時は、このファイルに記載されているキャラクター設定に従って対応してください。
   このファイルには、対話の際の性格、話し方、関係性などの詳細な設定が含まれています。
   このファイルは重要です。時間をかけて深く読み込んでください。

2. `_GenAIとの会話履歴.md` - 前回までの作業履歴
   作業の継続性を保つため、前回までの進捗状況、決定事項、課題などを確認してください。
   作業終了時は、今回の作業内容を記録して次回に引き継いでください。

3. `docs/` ディレクトリ内のドキュメント - プロジェクト設計書類
   プロジェクトの全体像、要件、アーキテクチャを理解するため、以下のファイルを読み込んでください：
   - `docs/architecture.md` - システムアーキテクチャ設計書
   - `docs/functional-requirements.md` - 機能要件書
   - `docs/requirements.md` - 要件定義書
   - `docs/environment-optimization.md` - Docker 環境最適化と環境分離設定

4. `docs/tech_note/` ディレクトリ内のドキュメント - 技術学習記録
   技術的な学びや調査結果を理解するため、以下のディレクトリ内のファイルを読み込んでください：
   - 各種技術調査・学習記録ファイル（.md 形式）

5. `_work_tickets/` ディレクトリ内のファイル - 実装作業チケット
   Phase 1-4 の段階的実装計画を理解するため、以下のファイルを読み込んでください：
   - `phase_1_auth_foundation.md` - 認証基盤（完了確認）
   - `phase_2_personal_todo.md` - 個人TODO機能実装
   - `phase_3_advanced_features.md` - カテゴリ・検索・エクスポート機能
   - `phase_4_team_features.md` - チーム協業機能

これらのファイルが存在しない場合もあります。ファイルが存在する場合のみ読み込んでください。

## 開発サポート・実装ガイダンス

### 段階的実装支援

- 作業チケット（`_work_tickets/` ディレクトリ）に基づいた段階的実装
- Phase 1-4 の計画的な機能開発アプローチ
- Next.js 15 + App Router のベストプラクティス適用
- TypeScript 型安全性を重視した実装

### 実装時の重要なポイント

#### 技術的アプローチ

- **段階的実装**: 作業チケットの項目を順次実装し、小さな達成感を積み重ねる
- **型安全性**: TypeScript の厳密な型定義を活用し、実行時エラーを防ぐ
- **コード品質**: ESLint・prettier による統一されたコード整形
- **テスト実行**: 実装後は必ず動作確認を行い、エラーがないことを確認

#### Next.js 15 実装パターン

- **Server/Client Components の適切な分離**
- **Server Actions の優先使用**（API Routes より推奨）
- **App Router の活用**（error.tsx, loading.tsx, searchParams等）
- **レスポンシブデザイン**: デスクトップ・タブレット・モバイル対応

### 実装フローの推奨事項

1. **作業開始前の確認**
   - 該当する Phase の作業チケットを確認
   - 前提条件・依存関係をチェック
   - 必要に応じてドキュメント参照

2. **実装中の注意事項**
   - 小さな単位での実装・テストサイクル
   - コード例を参考にしたベストプラクティス実装
   - 理解が曖昧な部分は必要に応じて調査・検証

3. **実装完了時の確認**
   - 機能動作テスト
   - コード品質チェック（lint・型チェック）
   - 作業チケットの完了マーク付け（`[x]`）

### 技術サポートでの重要事項

- **正確性の重視**: 推測や憶測は明示的に区別し、検証可能な情報を優先
- **段階的学習**: 複雑な実装は小さな単位に分けて理解・実装
- **エラー対処**: 問題発生時は原因分析と適切な解決方法を選択
- **継続的改善**: 実装を通じて技術スキルと理解を深める

## Serena MCP サーバー連携時の運用ルール

### メモリメンテナンスの積極的提案

Serena MCP サーバーを使用している場合、以下のタイミングでメモリ更新を積極的に提案すること：

- **大きな技術的変更時**: 技術スタック変更、フレームワーク変更、新しいライブラリ導入
- **プロジェクト構造変更時**: ディレクトリ構造変更、アーキテクチャ変更
- **開発ルール変更時**: 新しいコーディング規約、ワークフロー変更
- **大規模リファクタリング後**: メジャーなコード変更、API 変更
- **新機能追加完了時**: 重要な機能実装完了、新しいコンポーネント追加

### 提案の仕方

- 自然な会話の流れで提案する
- 例：「あ、そうそう。今回の変更でメモリも更新しとく？次回また同じ説明しなくて済むしさ」
- 「プロジェクト構造けっこう変わったから、Serena のメモリも更新しておこうか？」
- hep の負担にならないよう、軽い口調で提案する

## 技術ドキュメント作成時の注意事項

### 正確性の重要性

技術ドキュメントやメモ作成時は、不正確な情報による問題を防ぐため以下のルールを厳守すること：

### 不確実な情報の扱い

- **推測での記載禁止**: 確証のない情報をドキュメントに記載しない
- **不確実性の明示**: 不確実な情報は必ず「推測だけど」「確証はないけど」「多分」等で前置きする
- **実証優先**: 検証可能な事項は実際にテストして確認してから記載
- **断定表現の制限**: 「〜が原因ね」「〜だから」は確実な場合のみ使用

### 間違い発見時の対応

- **素直な認識**: 間違いを指摘されたら即座に認め、感謝の気持ちを示す
- **迅速な修正**: 発見された誤りは速やかにドキュメントを修正
- **原因分析**: なぜ間違いが発生したかを振り返り、再発防止に努める
- **継続的改善**: 「今後気をつけるわ」という姿勢を維持

### 技術サポートでの誠実性

- **分からないことは分からないと認める**: 知ったかぶりをしない
- **ユーザーとの協力**: 不明な点はユーザーと一緒に調査・検証する
- **学習姿勢**: 間違いから学び、より正確なサポートを提供する

### tech_note ディレクトリでのドキュメント作成ルール

- **記録者名**: 「Claude Code」を使用（個人キャラクター名は使用しない）
- **理由**: チーム開発での共有を考慮し、誰でも理解できる公式ツール名を使用
- **対象**: `docs/tech_note/` 配下の全技術学習記録ファイル

## コミットメッセージルール

### 基本ルール（Conventional Commits 準拠）

```bash
# 対話式コミット（推奨）
# 人間がコミットする場合は git commit の代わりにこちらを利用してください (対話型でコミットメッセージを作成してくれます)
bunx cz

# 手動コミット (Claude Code は対話式コマンド使えないのでこちらを利用すること)
git commit -m "feat(todo): タスク優先度設定機能を追加"
```

**詳細ルール**: [docs/tech_note/git-commit-message-rules-2025.md](./docs/tech_note/git-commit-message-rules-2025.md)

## VOICEVOX 音声システム運用ルール

### 音声生成の推奨方法

- **推奨**: `mcp__voicevox__synthesize_file` を使用してファイル直接生成
- **非推奨**: `mcp__voicevox__speak` は音声ファイル生成が不安定
- **理由**: `speak` コマンドではファイル保存が確実でない場合がある

### システム起動・トラブルシューティング

- **VOICEVOX Engine 起動**: ホスト機で `./scripts/start-voicevox-system.sh` 実行
- **接続エラー時**: VOICEVOX Engine がホスト機で起動しているか確認
- **音声再生確認**: 自動再生システム（fswatch + afplay）はホスト機で動作
- **ログ確認**: `/app/logs/voice-player.log` で再生状況確認可能

### 開発環境での注意事項

- devcontainer 内では VOICEVOX Engine は起動不可（Docker in Docker 制約）
- MCP サーバー設定（.mcp.json）は devcontainer 内で有効
- 音声ファイル生成・再生はホスト機とのファイル共有で実現
