# Serena MCP サーバー 概要と基本的な使い方

## 概要

Serena MCP サーバーは Claude Code と連携する Model Context Protocol (MCP) サーバーです。大規模なコードベースでの開発効率を大幅に向上させる機能を提供します。

## 主な特徴

### 1. プロジェクト理解とメモリ機能

- **オンボーディング**: プロジェクト全体を一度分析し、重要な情報をメモリファイルに保存
- **継続的な文脈理解**: 技術スタック、プロジェクト構造、開発ルールを記憶
- **手動メンテナンス**: メモリは自動更新されないため、大きな変更時に Claude に更新を依頼

### 2. 効率的なコード検索・操作

- **シンボル単位検索**: `find_symbol` で関数・クラス単位での正確な検索
- **構造把握**: `get_symbols_overview` でファイル内のシンボル構造を一覧表示
- **パターン検索**: `search_for_pattern` で正規表現による柔軟な検索

### 3. Token 効率性

- **段階的情報取得**: 構造確認 → 必要な部分だけ詳細取得
- **ピンポイント検索**: ファイル全体ではなく必要な関数・クラスのみを取得
- **メモリとの組み合わせ**: 頻繁に変わらない情報はメモリから、最新情報はリアルタイム取得

## メモリ管理の仕組み

### メモリに適した情報

- プロジェクト概要と技術スタック
- 開発コマンドとワークフロー
- コードスタイル・規約
- タスク完了時のチェックリスト

### リアルタイム取得が必要な情報

- 個別ファイルの具体的なコード実装
- 最新の変更内容
- デバッグ情報

### メモリの更新タイミング

- プロジェクト初期設定時（オンボーディング）
- 技術スタック変更時
- 新しい開発ルール導入時
- 大規模なリファクタリング後

## 基本的な使い方

**重要**: 以下のコマンドは開発者（人間）が直接実行するものではありません。Claude が内部的に適切なコマンドを選択・実行します。開発者は普通に Claude と会話するだけで構いません。

### 開発者の使い方

- 普通に Claude と会話する（「Task コンポーネント作って」「この関数を確認して」など）
- Serena のコマンドを意識する必要なし
- Claude が自動的に最適な Serena 機能を活用

### Claude が内部で使用する主なコマンド

#### 1. プロジェクト初期化時

- `activate_project()`: プロジェクトをアクティブ化
- `onboarding()`: プロジェクト全体分析とメモリ作成
- `write_memory()`: 重要な情報をメモリに保存

#### 2. コード検索・分析時

- `get_symbols_overview()`: ファイル内のシンボル構造把握
- `find_symbol()`: 特定の関数・クラス検索
- `search_for_pattern()`: 正規表現パターン検索

#### 3. 情報管理時

- `list_memories()`: 保存済みメモリ一覧確認
- `read_memory()`: メモリから情報取得
- `write_memory()`: メモリ内容更新

## Claude 直接使用との比較

| 項目                   | Claude 直接        | Serena MCP           |
| ---------------------- | ------------------ | -------------------- |
| ファイル読み込み       | 全体を毎回読み込み | 必要な部分のみ取得   |
| プロジェクト理解       | 毎回説明が必要     | メモリから即座に取得 |
| Token 消費             | 大量消費           | 効率的な消費         |
| 大規模プロジェクト対応 | 制限あり           | 高い対応力           |

## Token 消費の効率性

### 従来の方法（Claude 直接）

```
Task作成依頼
→ src/ ディレクトリ全体読み込み（大量token）
→ package.json 読み込み（技術スタック確認）
→ Prisma スキーマ読み込み（データ構造確認）
→ layout.tsx 読み込み（スタイル確認）
→ コンポーネント作成
```

### Serena を使用した場合

```
Task作成依頼
→ メモリから技術スタック・データ構造取得（最小token）
→ 既存コンポーネントがあれば find_symbol で参照
→ すぐにコンポーネント作成
```

## サーバー起動について

- **起動の必要性**: VSCode で自動起動設定済み（`.vscode/tasks.json`）
- **ファイル変更への影響**: サーバーが起動していなくてもファイル変更は問題なし
- **リアルタイム検知**: 変更の即座な検知は期待せず、必要時に再取得

## 実際の運用方針

1. **初期設定**: オンボーディングでプロジェクト理解をメモリに保存
2. **日常開発**: find_symbol や search_for_pattern でリアルタイム情報取得
3. **大きな変更時**: メモリの手動更新
4. **新機能追加**: 必要に応じてメモリに追記

## 効果的な活用シーン

- 大規模なコードベースでの開発
- チーム開発での知識共有
- 複雑なプロジェクト構造の理解
- 効率的なデバッグとリファクタリング

## プロジェクト設定とファイル管理

### .mcp.json による自動起動設定

プロジェクトルートに配置された `.mcp.json` ファイルには Serena の起動設定が記述されています：

```json
{
  "mcpServers": {
    "serena": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/oraios/serena",
        "serena",
        "start-mcp-server",
        "--context",
        "ide-assistant"
      ],
      "env": {}
    }
  }
}
```

**Claude Code がプロジェクトを開くと**：

1. `.mcp.json` ファイルを自動認識
2. 設定されている Serena サーバーを自動起動
3. Claude から Serena の機能が利用可能になる

この仕組みにより、プロジェクトを開くだけで Serena が自動的に利用可能になります。

### .serena ディレクトリの構成

Serena が作成する `.serena/` ディレクトリには以下のファイルが含まれます：

```
.serena/
├── project.yml              # プロジェクト設定ファイル
├── memories/                # プロジェクト理解情報（メモリ）
│   ├── project_overview.md
│   ├── suggested_commands.md
│   ├── code_style_and_conventions.md
│   └── task_completion_checklist.md
├── cache/                   # 一時的なキャッシュファイル
└── language_servers/        # Language Server 関連ファイル
```

**gitignore する理由**：

- **個人環境依存**: メモリの内容は個人の理解・分析に基づく
- **キャッシュファイル**: 環境固有の一時ファイルが含まれる
- **Language Server 設定**: 個人の開発環境に依存する設定
- **チーム開発**: 各メンバーが独自にオンボーディングを行う方が適切

新しいプロジェクトメンバーは `.mcp.json` から Serena を利用開始し、個人の `.serena/` ディレクトリを新規作成することが推奨されます。

## 注意点

- メモリは自動更新されないため、手動メンテナンスが必要
- リアルタイム変更検知には限界がある
- プロジェクト初期の token 投資が必要（その後で回収可能）
- Serena サーバー起動時にブラウザで「Serena logs」ページが開きます
- ログページでは Serena の動作状況がリアルタイムで確認できます（タブを閉じてもサーバーは継続動作）

---

_最終更新: 2025-08-08_
_記録者: Claude Code_
