# TODO アプリ 機能要件書

## 実装フェーズ概要

### Phase 1: 認証基盤 (Week 1-2)

- NextAuth.js v5 セットアップ
- OAuth 認証 (Google, GitHub)
- 基本的なユーザー登録・ログイン（SSO）
- データベースユーザー分離
- セキュリティヘッダー・CSP設定

### Phase 2: モダンUI基盤構築 (Week 2-3)

#### Phase 2: Tailwind CSS v4 導入

- @theme ディレクティブ・OKLCH色空間導入
- パフォーマンス向上・バンドルサイズ削減
- 従来設定からCSS設定への移行

#### Phase 2b: shadcn/ui セットアップ

- コード優先コンポーネントライブラリ導入
- Radix UI + Tailwind CSS統合
- Zod + React Hook Form統合パターン
- ダークモード対応・テーマシステム

#### Phase 2c: モダン状態管理基盤

- TanStack Query：Server State（API データ・キャッシング・同期）
- Zustand：Client State（UI状態・フィルター・ローカルロジック）
- 楽観的更新・エラーハンドリングパターン
- Query Key Factory・型安全性確保

### Phase 3: 個人 TODO 機能 (Week 3-4)

- 認証状態でのタスク・カテゴリ管理
- モダン状態管理によるリアルタイム同期
- 楽観的更新による高速UI体験
- 基本的なフィルタリング・ソート
- 個人データの完全分離

### Phase 4: 高度機能 (Week 5)

- カテゴリ管理機能
- キーワード検索機能
- データエクスポート/インポート
- パフォーマンス最適化・大量データ対応

### Phase 5: チーム機能 (Week 6-8)

- チーム作成・管理・招待
- 階層的権限ベースアクセス制御 (OWNER/ADMIN/MEMBER)
- チーム共有タスク・協業機能
- メール通知システム・招待メール
- チーム・個人コンテキスト切り替え

### Phase 6: 高度認証機能 (WANT)

- グローバル権限管理 (USER/MODERATOR/ADMIN)
- Data Access Layer による集中認証
- OAuth Token Rotation (Google/GitHub)
- セキュリティモニタリング・監査ログ
- 企業グレード認証・運用監視機能

## 技術アーキテクチャ

### フロントエンド

- **Framework**: Next.js 15 (App Router)
- **UI**: shadcn/ui + Tailwind CSS v4
- **状態管理**: TanStack Query (Server State) + Zustand (Client State)
- **フォーム**: React Hook Form + Zod
- **認証**: NextAuth.js v5 (OAuth専用)

### バックエンド

- **API**: Next.js App Router API Routes
- **データベース**: PostgreSQL + Prisma ORM
- **認証**: NextAuth.js v5 + Data Access Layer
- **メール**: Resend/SendGrid (招待・通知)

### 開発・運用

- **開発環境**: Docker + Docker Compose
- **型安全性**: TypeScript + Zod validation
- **テスト**: Playwright (E2E) + Vitest (Unit)
- **品質**: ESLint + Prettier + Husky

## 機能一覧

### 認証・アカウント管理 【Phase 1】

#### 基本認証機能

- **OAuth専用認証**: Google, GitHub プロバイダー
- **セッション管理**: JWT + Database session ハイブリッド
- **プロフィール管理**: 表示名・アバター画像編集
- **セッション制御**: アクティブセッション管理・無効化機能

#### セキュリティ機能

- **CSRF対策**: NextAuth.js内蔵機能
- **セキュリティヘッダー**: CSP・XSS・Clickjacking対策
- **セッション有効期限**: 30日間・自動延長
- **セッション無効化**: ログアウト時・セキュリティ違反時

### 個人TODO管理 【Phase 3】

#### タスク管理 (TanStack Query + Zustand 統合)

- **高速タスク作成**: 楽観的更新による即座のUI反映
- **リアルタイム同期**: 背景データ同期・自動更新
- **ステータス管理**: 未着手・着手中・完了（ワンクリック変更）
- **優先度設定**: 高・中・低（色分け表示・OKLCH色空間）
- **期限設定**: カレンダー統合・期限通知

#### モダンUI体験 (shadcn/ui)

- **モーダルベースUI**: 作成・編集・削除のモーダル統合
- **レスポンシブデザイン**: デスクトップ・タブレット・モバイル最適化
- **ダークモード**: システム・手動切り替え・設定記憶
- **アクセシビリティ**: WCAG 2.1 AA準拠・キーボード操作完全対応

#### フィルタリング・ソート (Zustand 状態管理)

- **リアルタイムフィルター**: ステータス・優先度・期限での絞り込み
- **高速検索**: デバウンス処理・検索履歴保存
- **ソート機能**: 作成日・期限・優先度・名前順
- **URL同期**: フィルター状態のURL連携・ブックマーク対応

### 高度機能 【Phase 4】

#### カテゴリ管理

- **カテゴリ作成**: 色分け表示・12色プリセット
- **階層管理**: 個人カテゴリ・チームカテゴリ分離
- **統計表示**: カテゴリ別タスク数・完了率
- **フィルタリング**: カテゴリ別・未分類タスク表示

#### 検索機能

- **全文検索**: タスク名・説明文での部分一致
- **高速検索**: インクリメンタルサーチ・検索結果ハイライト
- **検索履歴**: localStorage連携・よく使う検索の保存
- **検索結果**: ヒット件数・検索条件表示

#### データ管理

- **エクスポート**: JSON・CSV形式・メタデータ付き
- **インポート**: データバリデーション・重複処理・プレビュー機能
- **データ統計**: 総タスク数・完了率・カテゴリ分析
- **データクリア**: 確認ダイアログ・バックアップ推奨

### チーム機能 【Phase 5】

#### チーム管理

- **チーム作成**: 名前・説明・作成数制限（5チームまで）
- **階層的権限**: OWNER（全権限） > ADMIN（管理権限） > MEMBER（基本権限）
- **チーム切り替え**: 個人モード ↔ チームモード
- **チーム統計**: メンバー数・アクティビティ・完了率

#### メンバー管理・招待システム

- **招待機能**: メール招待・招待リンク生成・QRコード
- **招待メール**: HTMLテンプレート・日英対応・自動送信
- **権限管理**: ロール変更・オーナー権限譲渡
- **メンバー操作**: 退退・除名・再招待機能

#### 協業機能

- **チームタスク**: 担当者アサイン・進捗共有
- **リアルタイム更新**: 同時編集・楽観的更新・競合解決
- **コメント機能**: タスクレベル・メンション・通知
- **活動履歴**: チーム全体・個人別アクティビティ

#### アクセス制御・セキュリティ

- **データ分離**: チーム間完全分離・権限ベースアクセス
- **権限チェック**: API・UI両レベル・階層的制御
- **監査ログ**: アクセス履歴・権限変更・重要操作記録

### 高度認証機能 【Phase 6: WANT】

#### グローバル権限管理

- **システム権限**: USER（一般）・MODERATOR（運営）・ADMIN（管理者）
- **権限統合**: グローバル権限 + チーム権限の複合制御
- **管理者機能**: 全ユーザー管理・全チーム監視・システム設定

#### セキュリティ強化

- **OAuth Token Rotation**: Google・GitHub のリフレッシュトークン管理
- **セキュリティモニタリング**: 不正アクセス検知・自動アラート
- **監査ログ**: 認証イベント・権限変更・セキュリティ違反記録
- **Data Access Layer**: 集中認証・統一権限チェック

#### 運用・監視

- **認証メトリクス**: ログイン成功率・アクティブユーザー・プロバイダー統計
- **管理ダッシュボード**: リアルタイム統計・ユーザー管理・セキュリティ状況
- **アラート機能**: セキュリティ違反・異常アクセス・システム障害通知

## 画面一覧

### 認証関連画面 【Phase 1】

#### `/auth/signin` - サインインページ

- Google・GitHub OAuth認証ボタン
- OAuth専用エラーメッセージ表示
- 利用規約・プライバシーポリシーリンク
- レスポンシブデザイン・アクセシビリティ対応

#### `/auth/error` - 認証エラーページ

- OAuth エラー種別別メッセージ表示
- 再試行・ホーム画面戻りボタン
- サポート問い合わせリンク

### メイン機能画面 【Phase 3】

#### `/` - ダッシュボード（ホーム画面）

- **認証前**: アプリ紹介・機能説明・OAuth サインインCTA
- **認証後**: 統計サマリー・最近のタスク・クイックアクション
- 個人・チームモード切り替え (Phase 5)

#### `/tasks` - タスク管理メイン画面

- **TaskList コンポーネント**: 一覧表示・楽観的更新・リアルタイム同期
- **FilterBar コンポーネント**: ステータス・優先度・検索・ソート
- **モーダル統合**: 作成・編集・削除・詳細表示
- **無限スクロール**: 大量タスク対応 (Phase 4)
- **ショートカット**: キーボード操作・アクセシビリティ

#### `/tasks/[id]` - タスク詳細ページ（オプション）

- 詳細情報表示・編集インライン
- コメント機能 (Phase 5)
- アクション履歴・変更ログ
- 関連タスク・カテゴリー情報

### 高度機能画面 【Phase 4】

#### `/categories` - カテゴリ管理ページ

- **CategoryList コンポーネント**: 一覧・統計・色分け表示
- **CategoryForm コンポーネント**: 作成・編集・色選択
- カテゴリ別タスク数・完了率表示
- 削除確認・関連タスク移行処理

#### `/search` - 検索結果ページ

- **SearchResults コンポーネント**: ヒット一覧・ハイライト表示
- **SearchBar コンポーネント**: インクリメンタル検索・履歴表示
- 検索フィルター・ソート組み合わせ
- 検索結果なし時の代替案表示

#### `/data` - データ管理ページ

- **ExportModal コンポーネント**: JSON・CSV形式選択・フィルター指定
- **ImportModal コンポーネント**: ドラッグ&ドロップ・プレビュー・検証
- データ統計ダッシュボード
- データクリア・バックアップ機能

### チーム機能画面 【Phase 5】

#### `/teams` - チーム一覧ページ

- **TeamCard コンポーネント**: 参加チーム一覧・ロール表示
- **TeamForm Modal**: チーム作成・編集
- チーム統計・アクティビティ概要
- 招待受け取り・新規作成CTA

#### `/teams/[id]` - チーム詳細・ダッシュボード

- チーム情報・統計・メンバー一覧
- チームタスク概要・最近のアクティビティ
- **ContextSwitcher**: 個人・チーム切り替え
- 管理者用設定・招待ボタン

#### `/teams/[id]/settings` - チーム設定ページ

- **TeamForm コンポーネント**: チーム情報編集
- **MemberInviteModal**: メンバー招待・ロール指定
- **TeamMemberList**: メンバー管理・ロール変更・除名
- チーム削除・データエクスポート機能

#### `/teams/[id]/members` - メンバー管理ページ

- **TeamMemberList コンポーネント**: 全メンバー一覧・詳細情報
- ロール変更・権限管理・活動履歴
- 招待状況・期限切れ招待管理
- メンバー統計・貢献度表示

#### `/invitations/[token]` - 招待受諾ページ

- 招待詳細・チーム情報表示
- 承諾・拒否ボタン・理由選択
- 認証状況確認・サインイン誘導
- 期限切れ・無効招待エラー処理

### 高度認証・管理画面 【Phase 6: WANT】

#### `/admin` - システム管理ダッシュボード

- ユーザー統計・認証メトリクス
- セキュリティアラート・監査ログ
- システム設定・プロバイダー管理
- パフォーマンス統計・エラーレポート

#### `/admin/users` - ユーザー管理ページ

- **UserManagementTable**: 全ユーザー一覧・検索・フィルター
- グローバルロール変更・アカウント無効化
- ユーザー詳細・アクティビティ履歴
- 一括操作・エクスポート機能

#### `/admin/teams` - チーム管理ページ

- **TeamManagementTable**: 全チーム一覧・監視
- チーム統計・メンバー構成・アクティビティ
- 問題チーム検知・介入機能
- チームデータエクスポート・レポート

#### `/moderation` - 運営ダッシュボード

- 複数チーム監視・アラート管理
- コンテンツモデレーション・報告処理
- 利用規約違反検知・対応ログ
- コミュニティ健全性レポート

### 共通・ユーティリティ画面

#### `/profile` - プロフィール設定ページ

- **ProfileForm コンポーネント**: 表示名・アバター編集
- **AuthProviders**: 連携済みプロバイダー管理・追加
- セッション管理・アクティブデバイス一覧
- アカウント削除・データエクスポート

#### `/settings` - アプリケーション設定ページ

- **UISettings**: テーマ・言語・表示設定
- **NotificationSettings**: メール通知・アプリ内通知
- **PrivacySettings**: データ共有・分析許可設定
- **AccessibilitySettings**: フォントサイズ・コントラスト・音声

#### 特殊ページ・エラーハンドリング

#### `/unauthorized` - アクセス拒否ページ

- 権限不足メッセージ・必要権限表示
- 適切なページへのナビゲーション
- サポート連絡先・権限申請方法

#### `/loading` - ローディング状態

- **Skeleton UI**: shadcn/ui Skeleton コンポーネント
- プログレッシブローディング
- タイムアウト時のエラー表示

#### `error.tsx` / `not-found.tsx` - エラー境界

- **Error Boundary**: 予期しないエラーのキャッチ
- エラー詳細・再試行ボタン
- **404 Page**: 適切なナビゲーション・検索機能
- ユーザーフレンドリーなエラーメッセージ

## 機能詳細・要件

### パフォーマンス要件

- **初回ページ読み込み**: LCP 3秒以内
- **タスク一覧表示**: 1秒以内 (1000件対応)
- **フィルタリング応答**: 500ms以内
- **API応答時間**: 95%のリクエストが1秒以内
- **チーム機能**: 50ユーザー同時アクセス対応

### アクセシビリティ要件 (WCAG 2.1 AA準拠)

- **キーボード操作**: 全機能マウス不要
- **スクリーンリーダー**: 適切なaria属性・セマンティックHTML
- **コントラスト比**: 4.5:1以上・色依存情報の回避
- **レスポンシブ**: 200%拡大・44pxタッチターゲット

### セキュリティ要件

- **OAuth専用認証**: パスワード保存なし
- **セッション管理**: 30日有効期限・自動延長
- **データ暗号化**: HTTPS通信・機密データ暗号化
- **権限制御**: 最小権限原則・階層的アクセス制御

### 品質要件

- **TypeScript**: 完全型安全性・strict mode
- **テストカバレッジ**: 80%以上・E2Eテスト必須
- **エラーハンドリング**: 全APIエラー・ネットワーク障害対応
- **国際化対応**: 日本語・英語・多言語拡張可能

---

**最終目標**: モダンWeb技術を活用した、個人・チーム両対応の高品質TODOアプリケーション。楽観的更新・リアルタイム同期による優れたUX、包括的アクセシビリティ、企業利用可能なセキュリティレベルを実現。
