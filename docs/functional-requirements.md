# TODO アプリ 機能要件書

## 実装フェーズ概要

### Phase 1: 認証基盤 (Week 1-2)

- NextAuth.js v5 セットアップ
- Email/Password 認証
- 基本的なユーザー登録・ログイン
- データベースユーザー分離

### Phase 2: 個人 TODO 機能 (Week 3-4)

- 認証状態でのタスク・カテゴリ管理
- 基本的なフィルタリング・ソート
- 個人データの完全分離

### Phase 3: OAuth + 高度機能 (Week 5)

- Google/GitHub OAuth 認証
- 検索機能
- データエクスポート/インポート

### Phase 4: チーム機能 (Week 6-8)

- チーム作成・管理・招待
- 権限ベースアクセス制御
- チーム共有タスク・協業機能

## 機能一覧

### 認証・アカウント管理 【Phase 1 & 3】

- ユーザー登録・ログイン・ログアウト
- Email/Password 認証
- OAuth 認証 (Google, GitHub)
- プロフィール管理 (名前、アバター)
- パスワードリセット

### チーム管理 【Phase 4】

- チーム作成・編集・削除
- メンバー招待 (Email 経由)
- メンバー管理 (権限設定: オーナー、管理者、メンバー)
- チームからの退退・除名
- チーム切り替え (個人モード ↔️ チームモード)

### タスク管理 【Phase 2 & 4】

**Phase 2 (Week 3-4) - 個人 TODO:**

- タスクの作成・編集・削除
- 優先度設定（高・中・低）
- 状態管理（未着手・着手中・完了）
- 期限設定

**Phase 4 (Week 6-8) - チーム機能:**

- 担当者アサイン (チームモード時)
- 個人タスク vs チームタスクの切り替え
- コメント機能 (チームタスク)

### カテゴリ管理 【Phase 2 & 4】

**Phase 2 (Week 3-4) - 個人 TODO:**

- カテゴリの作成・編集・削除
- 色分け表示
- カテゴリ別フィルタリング

**Phase 4 (Week 6-8) - チーム機能:**

- 個人カテゴリ vs チームカテゴリ

### 検索・フィルタ 【Phase 2 & 3】

**Phase 2 (Week 3-4) - 基本機能:**

- 優先度別フィルタ
- 状態別フィルタ（未着手・着手中・完了）
- 期限順ソート
- 作成日ソート

**Phase 3 (Week 5) - 高度機能:**

- キーワード検索

**Phase 4 (Week 6-8) - チーム機能:**

- 担当者別フィルタ (チームモード時)

### データ管理 【Phase 3】

- JSON エクスポート (個人・チーム単位)
- CSV エクスポート (個人・チーム単位)
- データインポート (権限チェック付き)

## 機能詳細

### 0. 認証・アカウント管理機能

#### 0.1 ユーザー登録

- **機能概要**: 新しいユーザーアカウントを作成
- **入力項目**:
  - メールアドレス (必須, 重複チェック)
  - パスワード (必須, 8 文字以上)
  - 表示名 (必須, 最大 50 文字)
- **OAuth 登録**: Google, GitHub アカウント連携
- **バリデーション**: メール形式、パスワード強度チェック
- **成功条件**: ユーザーアカウント作成、登録完了通知

#### 0.2 ユーザーログイン

- **機能概要**: 既存ユーザーの認証とセッション作成
- **認証手段**:
  - Email + Password
  - OAuth (Google, GitHub)
- **セッション**: JWT + Database セッションのハイブリッド
- **Remember Me**: ログイン状態維持 (30 日間)
- **セキュリティ**: ブルートフォース攻撃対策 (レートリミット)

#### 0.3 パスワードリセット

- **機能概要**: パスワード忘却時のリセット機能
- **フロー**:
  1. メールアドレス入力
  2. リセットメール送信 (有効期限 1 時間)
  3. リンククリックで新パスワード設定
- **セキュリティ**: トークンの一回限り使用、有効期切れ自動無効化

### 0.4 チーム管理機能

#### 0.4.1 チーム作成

- **機能概要**: 新しいチームを作成し、オーナーになる
- **入力項目**:
  - チーム名 (必須, 最大 100 文字)
  - チーム説明 (任意, 最大 500 文字)
- **権限**: チーム作成者が自動でオーナーになる
- **制約**: 1 ユーザーあたり最大 5 チームまで (初期限定)

#### 0.4.2 メンバー招待

- **機能概要**: チームに新しいメンバーを招待
- **招待方法**:
  - メールアドレスで招待 (ユーザー未登録でも可)
  - 招待リンクでの招待 (一回限り、期限付き)
- **権限設定**: 招待時にメンバー権限を指定
  - メンバー (デフォルト): タスク作成・編集
  - 管理者: メンバー管理権限も付与
- **必要権限**: オーナーまたは管理者のみ招待可能

#### 0.4.3 権限管理

- **オーナー**: 全権限 (チーム削除、権限変更等)
- **管理者**: メンバー管理、タスク管理
- **メンバー**: タスク作成・編集のみ
- **権限変更**: オーナーのみ実行可能
- **オーナー権限譲渡**: 他メンバーにオーナー権限を譲渡可能

### 1. タスク管理機能

#### 1.1 タスク作成

- **機能概要**: 新しいタスクを作成する (個人またはチーム)
- **入力項目**:
  - タスク名 (必須, 最大 100 文字)
  - 説明 (任意, 最大 500 文字)
  - 優先度 (必須, 選択式)
    - 選択肢: 高, 中, 低
  - 状態 (必須, 選択式)
    - 選択肢: 未着手, 着手中, 完了
    - default: 未着手
  - 期限 (任意)
  - カテゴリ (任意)
  - **担当者 (チームモード時のみ)**: チームメンバーから選択
  - **タスクタイプ**: 個人タスク または チームタスク
- **バリデーション**:
  - タスク名は空文字不可
  - 期限は、どの過去日付でも登録可能
  - 担当者はチームメンバーのみ指定可能
- **成功条件**: タスクがデータベースに保存され、一覧に表示される
- **権限制御**: チームタスクはチームメンバーのみ閲覧可能

#### 1.2 タスク一覧表示

- **機能概要**: 登録されているタスクを一覧表示する (コンテキスト別)
- **表示コンテキスト**:
  - 個人モード: 自分のタスクのみ
  - チームモード: チーム全体のタスク
- **表示項目**:
  - タスク名
  - 優先度 (色分け表示)
  - 状態 (未着手/着手中/完了のバッジ表示)
  - 期限
  - 作成日時
  - **担当者 (チームモード時)**: ユーザー名とアバター
  - **タスクタイプ表示**: 個人/チームタスクの区別
- **ソート機能**:
  - 作成日時 (昇順/降順)
  - 期限 (昇順/降順)
  - 優先度 (高 → 低/低 → 高)
  - 担当者名 (チームモード時)
- **フィルタ機能**:
  - 状態別 (全て/未着手/着手中/完了)
  - 優先度別
  - カテゴリ別
  - **担当者別 (チームモード時)**: 自分のタスクのみ、全メンバー、特定メンバー
  - **タスクタイプ別**: 個人タスクのみ、チームタスクのみ

#### 1.3 タスク編集

- **機能概要**: 既存タスクの情報を変更する
- **編集可能項目**: タスク作成時と同じ項目
- **制約**: タスク ID は変更不可
- **成功条件**: 変更内容がデータベースに反映される

#### 1.4 タスク削除

- **機能概要**: 不要なタスクを削除する
- **確認機能**: 削除前に確認ダイアログを表示
- **成功条件**: タスクがデータベースから削除され、一覧から消える

#### 1.5 タスク状態変更

- **機能概要**: タスクの状態を変更する
- **操作方法**:
  - ドロップダウンメニューでの状態選択
  - ボタンクリックでの状態切り替え
- **状態遷移**: 未着手 → 着手中 → 完了 (逆方向の変更も可能)
- **視覚的フィードバック**:
  - 未着手: グレー表示
  - 着手中: 青色表示、進行中アイコン
  - 完了: 緑色表示、取り消し線、チェックマーク

### 2. カテゴリ管理機能

#### 2.1 カテゴリ作成

- **機能概要**: タスクを分類するためのカテゴリを作成 (個人またはチーム)
- **入力項目**:
  - カテゴリ名 (必須, 最大 50 文字)
  - 色 (選択式, 12 色から選択)
  - **スコープ**: 個人カテゴリ または チームカテゴリ
- **バリデーション**: 同一スコープ内で重複するカテゴリ名は不可
- **権限制御**: チームカテゴリはチームメンバーのみ作成可能

#### 2.2 カテゴリ一覧表示

- **機能概要**: 作成されたカテゴリを一覧表示
- **表示項目**: カテゴリ名、色、所属タスク数

#### 2.3 カテゴリ編集・削除

- **編集**: カテゴリ名と色の変更
- **削除**: カテゴリに所属するタスクがある場合は警告表示

### 3. 検索機能

#### 3.1 タスク検索

- **機能概要**: キーワードでタスクを検索
- **検索対象**: タスク名、説明文
- **検索方式**: 部分一致
- **結果表示**: 該当するタスクをハイライト表示

### 4. データ管理機能

#### 4.1 データエクスポート

- **機能概要**: タスクデータを JSON または CSV 形式でエクスポート
- **エクスポート単位**:
  - 個人モード: 自分のタスクのみ
  - チームモード: チーム全体のタスク (管理者権限必要)
- **エクスポート対象**: 全タスクまたはフィルタ結果
- **メタデータ含む**: 作成者、担当者、タイムスタンプ情報

#### 4.2 データインポート

- **機能概要**: JSON または CSV 形式のファイルからタスクデータをインポート
- **権限チェック**: インポート先のコンテキスト (個人/チーム) で権限チェック
- **バリデーション**: インポート前にデータ形式・権限をチェック
- **競合処理**: 重複データの上書き/スキップ選択機能
- **担当者マッピング**: インポート時に外部ユーザーをチームメンバーにマッピング

## UI/UX 要件

### レスポンシブデザイン

- **デスクトップ**: 1200px 以上
- **タブレット**: 768px〜1199px
- **モバイル**: 767px 以下

### アクセシビリティ

- **キーボード操作**: 全機能をキーボードのみで操作可能
- **スクリーンリーダー**: 適切な aria-label 属性の設定
- **コントラスト**: WCAG 2.1 AA 基準を満たす色彩設計

### パフォーマンス

- **初回読み込み**: 3 秒以内
- **画面遷移**: 1 秒以内
- **API 応答**: 1 秒以内

## 認証・セキュリティ設計

### 認証フロー

- **JWT + Database Session ハイブリッド**: パフォーマンスとセキュリティを両立
- **セッション管理**: アクティブセッションの自動無効化 (30 日間非アクティブ)
- **パスワードポリシー**: 12 文字以上。英数字記号組み合わせ
- **ブルートフォース対策**: IP アドレス単位で 15 分間に 5 回まで

### データアクセス制御

- **Row Level Security**: ユーザー・チーム別のデータ分離
- **API 権限チェック**: 全ての API エンドポイントで認証状態を確認
- **CORS 設定**: 許可したオリジンのみアクセス許可
- **CSRF 対策**: NextAuth.js の内蔵機能で自動対応

### チームアクセス制御

- **メンバーシップ検証**: チームリソースアクセス時にメンバー資格を自動チェック
- **権限ベースアクセス**: オーナー > 管理者 > メンバーの階層構造
- **リソース分離**: チーム間でのデータ漏洩防止

## エラーハンドリング・例外処理

### 認証エラー

- **ログイン失敗**: 具体的な失敗理由を間接的に表示 (セキュリティ考慮)
- **セッション期限切れ**: 自動ログアウトと再ログイン促し
- **権限不足**: 403 Forbidden で明確なメッセージ表示

### バリデーションエラー

- **リアルタイムバリデーション**: フォーム入力時の即座フィードバック
- **統一エラー形式**: Zod スキーマによる一貫したエラーメッセージ
- **フィールドレベルエラー**: 具体的な入力項目と改善方法を表示

### システムエラー

- **データベースエラー**: 適切なユーザーメッセージとログ記録
- **API エラー**: 統一的なエラーレスポンス形式
- **予期しないエラー**: Error Boundary での全体キャッチとフォールバック UI

### ネットワークエラー

- **オフライン時**: オフライン状態表示とローカルデータの活用
- **ネットワークタイムアウト**: 自動リトライ機能 (指数バックオフ)
- **再接続時**: データ同期と競合状態解決

## パフォーマンス要件

### フロントエンドパフォーマンス

- **初回ページ読み込み**: 3 秒以内 (LCP)
- **タスク一覧表示**: 1 秒以内
- **フィルタリングレスポンス**: 500ms 以内
- **フォーム送信**: 1 秒以内

### API パフォーマンス

- **認証 API**: 2 秒以内
- **CRUD API**: 1 秒以内
- **検索 API**: 500ms 以内
- **データエクスポート**: ファイルサイズによらず 10 秒以内

### 同時接続数

- **チーム当たり**: 50 ユーザー同時アクセス
- **システム全体**: 1000 ユーザー同時アクセス (初期目標)
